## 1. 引言

小❤发现，MySQL 知识点虽多，但考来考去最常见的也就那几个。

这不，最近在梳理我之前的面试资料时，发现面试过程中，基本上都会问到 MySQL 数据库相关的知识点。而 MySQL 中，问得最多的就是事务、隔离级别以及 MVCC 这几个，无论是互联网大厂、小厂，甚至是国企，它们的覆盖率竟高达 80%。

其实面试官也知道，八股文谁都会背，但是可以说明白，甚至说透彻的候选人却是凤毛麟角。

所以今天小❤就带大家来解锁那些藏在 MySQL 底层的黑科技：事务、隔离级别和 MVCC。

https://zhuanlan.zhihu.com/p/52977862

## 2. 事务

### 2.1 直播打赏

首先，让我们来谈谈事务。

事务就像一场魔法表演，它可以**确保一系列数据库操作要么全部执行成功，要么一点都不执行。**

比如你在看直播时，想打赏 500 块给美女主播，需要扣除你的账户余额，并同时增加美女主播的账户金额。

如果转账的两个操作中的一个失败，那你就可能损失金钱或者让金钱陷入虚空，美女主播也就收不到钱了。

这时，事务就派上用场了。

它可以保证这两个操作要么同时成功，要么同时失败，绝不会出现一半成功一半失败的尴尬局面。



好，我们**总结一下：**

> 数据库为什么要有事务？

答：为了保证数据的最终一致性。不明白什么是最终一致性的，可以看看我这篇文章：深入浅出：分布式、CAP 和 BASE 理论。



### 2.2 事务特性

明白了什么是事务，以及为什么需要事务。接下来我们聊一聊事务的 4 个特性：**原子性、一致性、隔离性和持久性**，简称 ACID。

#### 原子性（Atomicity）

原子性是指**事务包含的操作要么全部成功，要么全部不成功**。

比如 A、B 账户的初始余额为 800 元，100元。此时，A 向 B 转账 500 元，那么分解开来就是 A 账户减 500 元，B 账户加 500 元。

最终结果是 A 账户余额为 300 元，B 账户余额为 600 元。这两个账户余额更新的操作，要么全部执行，要么都不执行。

拿给美女主播打赏的例子，原子性可以保证：要么钱还在，要么收获主播的一声**谢谢哥哥**！



#### 一致性（Consistency）

**事务执行前，和执行后都会保持一致性状态**。

A、B 账户在转账后，会发生两种情况：

1. 钱转到 B 账户里了，这时 A、B 账户分别为 300、600 元；
2. 钱转出去的过程中数据库网络断开，事务回滚了，A、B 账户还是 800、100 元。

无论怎样，事务发生前后，A、B 银行账户的总额都应该为 900 元，这就是前后一致性。



#### 隔离性（Isolation）

隔离性是当多个用户并发访问数据库时，不管是不是操作同一个库、还是同一张表，数据库为每一个用户开启的事务，不能被其他事务的操作所干扰，多个并发事务之间也要相互隔离。

比如，A 向 B 转账的时候，不管别人怎么转账，都不会影响他们的交易。

拿给美女主播打赏的例子，隔离性就是：不管有多少人在给主播打赏，你只要转了钱，就能收获主播的一声**谢谢哥哥**！



#### 持久性（Durability）

**一个事务一旦被提交了，那么对数据库中的数据的改变就是持久性的【即保存到磁盘里】**，即便是在数据库系统遇到故障的情况下也不会丢失提交事务的操作。 

拿给美女主播打赏的例子，持久性就是：你只要给主播转了钱，钱就进了她的账户，无论收获主播的多少声**谢谢好哥哥**，钱也回不来了。



好，我们**总结一下：**

> 为什么事务有这几大特性？

我们要保证事务的数据一致性，就需要一些机制来实现，这几种机制就是事务的几个特性。分别是原子性、一致性、隔离性和持久性，其中**一致性是目的，而原子性、一致性和隔离性都是为了实现数据一致性的手段**。



## 3. 事务并发和隔离

### 事务并发

并发是指计算机系统或程序在同一时间内同时处理多个任务或操作的能力，也就是允许多个用户进程去处理同一块临界区。

> 想从进程或处理器的角度来理解并发的，可以看我之前的这篇文章：GPM调度模型

拿打赏主播来举例，并发就是多个观众都想打赏主播，如果你们一起转钱，那主播的账户余额该怎么修改呢？

这里的任务就是转账，用户进程就是负责交易的服务器进程，临界区就是主播账户的存储空间。

如果出现了事务并发，就会带来一些意想不到的问题，例如常见的**脏写、脏读、重复读和幻读**。



### 脏写

脏写是指：在事务并发的时候，**一个事务可以修改另外一个正在进行中的事务的数据，这可能会导致一个写的事务会覆盖另外一个写的事务数据**。

当你和小帅一起给美女主播打赏时，你打赏了 500 块，小帅打赏了 1000 块，在写入数据库的时候，你写入的数据被小帅的数据给覆盖了。

最后导致的结果就是，你钱没了，而美女主播在直播间说的是**谢谢小帅哥哥**的打赏！



### 事务隔离

500 块钱没了，美女主播还不理你，你很伤心，但是不知道怎么办？

别难过！事务隔离可以帮你。

MySQL 提供了事务隔离级别，包括：**读未提交、读已提交、可重复读以及串行化**，来解决事务中各种并发问题，专治各种不开心。



### RU - 读未提交（Read uncommitted）

RU（读未提交）是指，如果一个事务开始写数据，则另外一个事务不允许同时进行写操作，但允许其他事务读取此行数据。

RU 可以“排他写”，但是不排斥读线程实现。

这种隔离级别可能会出现**脏读，即事务 B 读取到了事务 A 未提交的数据**。