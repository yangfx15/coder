# 标题：破解海外支付难题：Google Play 和 Apple Store 接入详解

### 引言

当 APP 出海时，海外支付是无法回避的关键环节。最常用的海外支付平台包括 Google Play 和 Apple Store（IAP 方式），其国内对等可参考支付宝和微信支付。虽然 PayPal 也常被使用，但在我们的业务中不常涉及，因此不在本文讨论范围内。

本文将详细解析 Google Play 和 Apple Store 的接入流程，以及业务中可能遇到的一些小坑。

### 常见业务交互流程

由于业务需要不同的充值套餐和订阅周期，我们需要提前在 Apple Store 和 Google Play 中配置商品，并为每个商品创建一个唯一 ID，存储在后台数据库中。客户端从后台获取商品列表，用户选择充值或订阅后，客户端请求 Google Play/Apple Store 并拉起支付页面。支付完成后，客户端将产品 ID、支付 Token、交易 ID 等信息传入后台并创建订单。

原始交易 ID 用于管理订阅订单的续订状态，后台需妥善存储。

### 海外支付的要点及难点

#### 一些背景

Google 和 Apple 未提供完整的流程和状态支持文档，中文资料亦不完整，因此我们以官方文档为准，采用测试驱动开发。服务端接口支持较落后，我们尽量选用 SDK 进行交互。由于 Google Play 和 Apple Store 的回调通知类型不一致，支付状态设计成为难点。

#### 支付状态流转

Apple 订阅的通知类型和 Google 的通知类型各异。结合实际业务，我们选用了完成订单、取消、续订失败、退订、续订成功等支付状态。

### 关键表结构

商品表和订单表记录了业务中的商品列表和用户购买状态。商品表需提前在三方支付平台上配置，订单表记录用户购买的商品状态和三方支付平台的交易凭据。

### 常见问题

##### 1）如何防止掉单

用户权益至关重要。为防止掉单，我们在客户端划账请求的 ACK 之前先调用后台接口生成订单。若用户支付后断网，重新打开客户端会检查未确认的请求。同时，业务平台接收到支付网关回调时，若已有订单则更新状态；否则发出告警。

##### 2）如何保证账单和订单正确性

为了保证订单的有序性，我们在业务系统禁止随意扭转订单状态，并在支付网关进行每日定时对账。业务后台会判断数据库状态与支付平台后台状态的一致性，发现差异则进行告警或更新。

### 小结

海外支付的接入涉及复杂的流程和细致的状态管理。通过合理的系统设计和流程优化，可以有效解决掉单和账单对账的问题，确保用户权益得到保障。