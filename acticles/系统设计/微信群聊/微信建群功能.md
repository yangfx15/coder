## 1. 引言

大家好，我是小❤。

微信作为 10 亿用户级别的全民 App，想必大家都用过，微信建群功能是微信里面核心的一个能力，它可以将数百个好友或陌生人放进一个群空间。

或许你已经在微信上体验过很多次群组聊天，但你是否好奇过这个背后的系统是如何设计的呢？

微信建群功能的背后是一套精心设计的架构，它确保了高并发、高性能，以及海量用户数据的存储和管理。

今天，小❤会结合微信建群的核心功能，一步一步地介绍微信建群功能的系统设计。



## 2. 系统需求

### 2.1 系统特点与功能需求

微信建群功能是社交应用的核心功能之一，它允许用户创建自己的社交圈子，与朋友、家人或共同兴趣爱好者进行交流。

系统的特点和功能需求包括：

- **创建群组**：用户可以创建新的聊天群组，邀请其他好友用户或陌生人加入。
- **群组管理**：群主和管理员能够管理群成员，设置规则和权限。
- **消息传递**：允许群成员发送文本、图片、音频、视频等多种类型的消息。
- **实时通信**：消息应该能够快速传递，确保实时互动。



### 2.2 非功能需求：应对高并发、高性能、海量存储

当我们面对10亿微信用户每天都可能使用建群功能的情景时，就需要处理大规模的用户并发。这就引出了系统的非功能需求，包括：

- **高并发**：系统需要支持大量用户同时创建和使用群组，以确保无延迟的用户体验。
- **高性能**：快速消息传递、即时响应，是数字社交的关键。
- **海量存储**：系统必须可扩展，以容纳用户生成的海量消息、媒体和群组数据。



## 3. 概要设计

在概要设计中，我们考虑了系统的核心组件和流程：

- **消息服务器**：这是信息的中转站，负责将消息传递给正确的群组成员。
- **用户数据库**：用于存储用户数据、群组信息和关系。
- **实时通信协议**：确保消息的快速传递，通常采用 WebSocket 或者长轮询技术。



## 4. 详细设计

接下来，我们深入探讨了三到四个核心功能的详细设计，包括：

- **群组创建**：用户请求创建群组时，系统会分配一个唯一的群组ID，该ID将被用于后续消息传递。
- **消息传递**：当用户发送消息时，消息服务器将负责将消息分发给群组的所有成员。
- **群组管理**：群主和管理员能够通过用户界面管理群组成员，指定权限和规则。
- **消息存储**：消息需要存储在可扩展的数据库中，以确保消息历史的可访问性。



### 4.1 群组创建

- **唯一ID分配**：当用户请求创建一个新群组时，系统生成一个唯一的群组ID，通常可以使用分布式ID生成器如Snowflake。
- **群组信息存储**：将群组ID和相关信息（例如群名、创建者ID等）存储在群组数据库中。
- **成员关联**：将群主添加为群组的创始成员，同时创建者也会成为管理员。
- **消息历史记录**：为了确保新成员能够访问以前的消息，将此新群组的群组ID与用户消息关联存储。

除了拉好友建群，微信还实现了面对面建群的能力。



#### 面对面建群

面对面建群功能通常涉及技术组件、数据表设计和核心业务交互流程如下：

**技术组件：**

1. **移动客户端应用**：提供用户界面，用于生成和扫描面对面建群随机码。
2. **服务器后端**：用于协调和处理面对面建群请求、生成随机码、以及管理创建的群聊。
3. **数据库**：存储用户、群组和关联信息。



**数据库表设计：**

1. **User 表**：存储用户信息，包括用户ID、昵称、头像等。
2. **Group 表**：存储群组信息，包括群ID、群名称、创建者ID等。
3. **GroupMember 表**：关联用户和群组，包括用户ID和群ID。
4. **RandomCode 表**：存储面对面建群的随机码和关联的群ID。
5. **QRCode 表**：存储生成的二维码信息，包括随机码和有效期等。

**核心业务交互流程：**

1. 用户A在移动客户端应用中创建一个新的群聊，系统生成一个随机码，并将群聊信息存储在Group表中。
2. 系统将生成的随机码保存在RandomCode表中，并关联到创建的群ID。
3. 用户A通过移动客户端应用将生成的随机码显示在屏幕上，以便周围的用户扫描。
4. 用户B、C等周围的用户在他们的应用中选择加入新的群聊，通过扫描用户A屏幕上的二维码获取随机码。
5. 当用户B、C扫描二维码后，他们的应用向服务器后端发送请求，验证随机码是否有效。
6. 服务器后端验证随机码，检查随机码是否存在于RandomCode表中，以及是否在有效期内。
7. 如果验证通过，服务器后端将用户B、C添加到群成员表GroupMember中，并返回成功响应。
8. 移动客户端应用收到成功响应后，更新用户B、C的群聊列表，展示他们已加入的新群聊。

这样，用户A通过创建随机码和周围的用户扫描二维码的方式成功建立了一个面对面建群。这个功能涉及了多个技术组件，包括服务器后端、数据库、二维码生成和验证等。同时，用户A作为群的创建者，在数据库中也会被标记为群主，有权限管理群成员。



### 2. **消息传递**

- **消息队列**：当用户发送消息时，系统将消息放入消息队列中。
- **消息分发**：消息服务器订阅消息队列，一旦有新消息，它会立即将消息传递给所有群组成员。
- **消息持久化**：存储消息历史记录，确保消息不会丢失。可以使用分布式文件系统或对象存储来存储媒体文件。

当某个成员在微信群里发言，系统需要处理消息的分发、通知其他成员、以及确保消息的显示。以下是这一功能的详细交互步骤，相关技术组件和数据库表存储方案：

#### 1. 消息发送：

1. 成员A在微信群中发送消息。
2. 客户端应用将消息通过HTTPS协议发送到微信服务器。

#### 2. 消息分发：

1. 微信服务器接收到消息并将其放入消息队列（如RabbitMQ或Kafka）中。

#### 3. 消息通知：

1. 订阅消息队列的消息服务器（消息推送服务）收到消息并处理。
2. 消息推送服务从消息队列中取出消息。
3. 消息推送服务将消息发送到订阅了此群组的成员的客户端。
4. 通过WebSocket等长连接技术，消息以实时方式推送给在线的群成员。

#### 4. 消息存储：

1. 微信服务器将消息存储在消息数据库中。这可能涉及到多个表，其中一些字段可能包括：
   - MessageID：唯一的消息标识符。
   - GroupID：群组的标识符。
   - SenderID：消息发送者的标识符。
   - Content：消息内容。
   - Timestamp：消息时间戳。

#### 5. 消息显示：

1. 客户端应用接收到消息并在群聊中显示消息。
2. 显示的消息通常包括发言者的昵称和头像，以便其他成员可以识别消息来源。

在这一过程中，涉及了多个技术组件和数据库表：

- **消息队列**：用于在微信服务器和消息服务器之间传递消息，以实现异步处理和分发。
- **消息推送服务**：处理订阅的消息队列，将消息实时推送给在线成员的客户端。
- **消息数据库表**：用于存储消息历史记录。可能有多个表，以支持消息的索引和高性能检索。
- **WebSocket或长连接技术**：用于实现实时消息推送给在线用户。

这些步骤和组件确保了微信群的消息能够实时分发给所有成员，同时也保留了消息历史记录以供后续查询。这是一个复杂而高效的系统，支持了数以亿计的微信群用户在全球范围内的通信需求。



### 消息存储和展示

在微信群中保存和展示用户的图片、视频或音频数据，通常需要进行数据存储和展示方面的设计。以下是一个详细描述数据表实现和业务交互流程的示例：

**数据表设计：**

1. **User表：** 保存用户的基本信息，如UserID、用户名、头像等。
2. **Group表：** 保存群聊的基本信息，如GroupID、群名、群头像等。
3. **Message表：** 用于存储消息，每个消息都有一个唯一的MessageID，消息内容（文本、图片、视频、音频等）、发送者UserID、接收群GroupID、消息类型（文本、图片、视频、音频）、发送时间等字段。
4. **Media表：** 存储用户上传的图片、视频、音频等媒体数据。每个媒体文件都有一个唯一的MediaID，文件路径、上传者UserID、上传时间等字段。
5. **GroupMember表：** 记录群成员，包括UserID、GroupID、入群时间等字段。



**业务交互流程：**

1. 用户A在群中发送一条带有图片、视频或音频的消息。
2. 移动客户端应用将消息内容和媒体文件上传到服务器后端。
3. 服务器后端接收到消息和媒体文件后，将消息内容存储到Message表中，同时将媒体文件存储到Media表中。在Message表中，会记录媒体文件的MediaID，以便关联消息和媒体。
4. 服务器后端会向所有群成员广播这条消息。移动客户端应用接收到消息后，会根据消息类型（文本、图片、视频、音频）加载对应的展示方式。
5. 当用户点击查看图片、视频或音频时，客户端应用会根据MediaID到Media表中获取对应的媒体文件路径，并将其展示给用户。

这个流程确保了消息和媒体文件的有效存储和展示。用户可以上传和查看各种类型的媒体数据，而服务器后端通过关联Message和Media表中的信息，实现了有效的消息存储和展示。



##### 3. **群组管理**

- **用户界面**：为群主和管理员提供用户友好的界面，允许他们管理成员、规则、消息等。
- **权限管理**：系统应支持各种权限级别，如群主、管理员和普通成员，以管理对消息和群组的访问权限。
- **规则制定**：允许群主设定群组规则，例如发言限制、成员加入审核等。

##### 4. **消息存储**

- **数据库表**：创建适当的数据库表，将消息和群组信息存储在关系型数据库（如MySQL）中。
- **消息索引**：对消息进行索引，以加速消息历史记录的查询。
- **数据分片**：随着系统规模的扩大，数据可能会被分片到多个数据库服务器上，这有助于提高性能和可伸缩性。



### 总结

微信建群功能的系统设计不仅仅是一个技术壮丽的展示，更是数字社交的魔法之一。通过高并发、高性能的设计，以及对海量数据的处理，微信创造了一个能让人们联系、分享和互动的数字社交魔法空间。

如果你曾好奇这些社交应用是如何工作的，希望这篇文章帮助你更好地理解了微信建群功能的背后系统设计。数字社交的世界无处不在，而它的魔法则是深思熟虑的系统设计。

希望你享受了这次探索之旅，下次再见！ 🚀