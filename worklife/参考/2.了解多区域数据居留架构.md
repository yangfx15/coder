### 关键点提要
高效的数据居留关键在于理解客户的动机（通常与GDPR无关）并将技术解决方案与合同承诺对齐。与各利益相关者接触有助于发掘具体项目要求，并定制数据居留以满足客户需求。
在区域内确立明确的“原子”作为数据的基本单元，确保了真实数据来源。跨区域管理信任涉及加密技术和彻底的威胁模型，地缘政治因素也起到了一定作用。
尤其在多区域情景中，一致性地执行相同操作，简化了系统管理，增强了可预测性，减少了意外问题。最小化复杂性和避免不必要的设计分叉有助于建立更加可靠的系统。
定制客户端路由策略在区域变换期间最小化中断，确保灵活性和适应性。基于子域的路由虽然有效，但在区域更改时可能会给客户带来不便，因此有必要探索替代方案。
认识到加速器和真正的全球数据库的强弱点对于数据居留成功至关重要。理解在主动-主动拓扑和冲突解决方法中的挑战，突显了需要一种细致的方法，而不仅仅依赖于数据库代理。

本文主要关注有效实施数据居留策略的同时，确保所有相关方有积极的参与体验。文章的核心思想围绕着将数据放置在单一来源之外的必要性。采用这种方法的动机有很多，如灾难恢复和地理冗余。核心概念是分散数据，确保特定的数据集在不同的区域存放，彼此间没有重叠，这种做法被称为数据居留。

### 原则一：了解你的客户（KYC）
实施数据居留的关键首步是识别目标受益者和背后的动机。与普遍误解不同，数据居留不是GDPR的要求。相反，通常是客户特定的需求和关切驱动。这涉及深入挖掘数据居留请求背后的原因，这些原因可能差异很大。

首先，解析谁以及为什么需要数据居留。与流行观点相反，这可能与GDPR合规性没有直接关联。与销售、客户及法律团队等多方利益相关者接触，以了解具体项目需求。目标是使技术实施与关于数据居留的合同承诺保持一致。

例如，在Rippling，这项努力的背后推动是来自欧盟的客户请求，他们寻求数据隐私和监管暴露的保证。这导致了包括禁止区域间通信在内的一系列限制，凸显了根据你的客户群体的独特需求定制解决方案的重要性。

此外，考虑可扩展性作为一个驱动因素。虽然基于蜂窝的架构可以增强系统的可扩展性，但实施完全分离的数据居留的决定应该基于特定需求。数据的分离和划分对于扩展可以是有利的，并创建独立的数据库和架构。

此外，数据居留还可以为你的合规性故事做贡献。对于需要处理多个政府的组织，每个政府有不同的规定和合规要求，按区域分离数据变得非常有用。例如，与特定政府规定相关的合规工作，如英国的独特劳动法，当数据存在于同一区域时，可以有效管理。这不仅解决了潜在的数据访问问题，还确保了在不同区域的不同合规需求中保持一致。

总之，关键的收获是要理解你的组织的需求和动机的复杂性。避免一刀切的做法，而是将数据居留策略定制到你的公司、利益相关者以及你所处的监管环境的具体需求中。

### 真理与信任的原则

在多区域部署的背景下，建立关于真理和信任的清晰原则至关重要。虽然知道数据的真实来源对于任何情况都是重要的，但在多区域场景中尤其关键。首先，确定一个基本单元，“原子”，在这个单元中，所有相关数据都居住在一个区域。这可以是组织实体，如公司、团队或组织，具体取决于你的业务结构。

任何涉及跨越这些原子边界的操作本质上都会成为跨区域场景。因此，定义这个原子单元对于确定你的多区域部署的真实数据来源至关重要。

在信任方面，由于不同区域拥有不同的数据，因此它们之间的通信变得必要。这可能涉及像跨区域共享认证令牌的场景。区域之间的信任级别是根据你的业务的具体需求和背景做出的决定。如果涉及到政府，尤其是如果数据单元放置在可能有冲突利益的区域，考虑地缘政治景观尤为重要。

在启动多区域部署之前，与你的安全团队或顾问合作进行彻底的威胁模型分析。理解每个涉及国家的潜在风险和监管要求。两个需要注意的关键方面是访问令牌和数据库访问，因为在这种情境下的每个应用都必须解决这些问题。

通过加密技术可以减少区域间的信任，但具体做法将根据你的业务需求来定。例如，你可能需要根据应用的需要评估无状态通信和撤销延迟之间的权衡。

与你的团队就这两个方面——访问令牌和数据库访问——进行讨论，因为它们往往会引发关于你的业务的其他相关考虑的讨论。在实施之前建立坚实的哲学和架构基础至关重要，以避免稍后在进入新市场或区域时重新评估基本设计模式。

### 坚持一致性

软件工程普遍适用的原则之一是始终做相同的事情，但在多区域场景中这一原则尤为重要。避免不必要的设计路径分叉对于系统的强壮性和可靠性至关重要。通过回顾一个与网络路由相关的历史例子来说明这一概念。

#### 图1：路由思考实验

考虑一个路由器设计，在常规路由模式下，系统运行效率高。但是，如果负载超过一定阈值，就会引入一个队列。这种看似合理的设计在系统运载能力超过50%的情况下可能导致灾难性的失败，因为在这种条件下设计本身的效率低下。

#### 图2：模拟结果

应用至多区域场景，其中路由决策频繁发生，选择始终执行相同操作的设计至关重要。例如，在处理入站流量时，避免包括逻辑分叉如“如果多区域；那么”。始终做相同的事情可以简化系统，使其更加可预测且易于维护。

此外，最小化复杂性和减少系统中分支的数量增加了成功的可能性。特别是在多区域场景中，应谨慎考虑地理接近性进行路由决策。为应对特殊情况实施罕见的代码路径，例如转向另一区域，可能是脆弱且难以彻底测试的。应用在不同区域之间的行为不对称，特别是关于同步一致性，可能导致难以追踪的微妙错误。

#### 图3：应用“始终做相同的事情”

例如，考虑这样的场景：一个区域同步地写入其本地数据库，而另一个区域异步地写入远程数据库。在第一个区域读取刚写入的数据会立即得到正确的结果，而在第二个区域你可能读到的是过时的数据。这样的不一致可能导致不可预测的行为，应当避免。追求设计的对称性，使两个区域共享相似的代码路径，确保系统更简单、更可靠。尽管这可能引入一些复杂性，但跨区域的统一性带来的好处超过潜在的缺点。

### 定制灵活的客户端路由策略

当遇到需要在不同区域之间切换的场景时，灵活和精确的客户端路由策略变得尤为重要。这不仅涉及软件的迁移，更涉及到用户体验和数据完整性的维持。要最大化所有区域的性能和可用性，你需要一套能够灵活应对突发事件的路由策略。

#### 实践中的挑战

例如，假设一个应用程序在美洲和欧洲有数据中心。如果美洲的数据中心出现故障，系统需要能够无缝地将用户流量重定向到欧洲的数据中心。这要求客户端路由策略的设计不仅要考虑正常操作，还要能应对异常情况。在实现这一策略时，关键在于如何设计故障转移机制和如何进行灵活的流量调度以维持服务的连续性和质量。

#### 实践建议

一种做法是使用DNS负载均衡，这种方法可以根据地理位置智能地将用户请求分配到最近的服务节点。但这需要高效的DNS配置和快速响应更改的能力。在监控方面，可实施连续的健康检查，以动态更新路由决策，确保流量总是被导向健康的数据中心。

还有一种方法是利用全局负载均衡器（GLB），它不仅按地理位置决定流量路由，还能根据服务器的实时性能和负荷来动态调整分配。这种方法减少了对单个区域的依赖，提高了整体系统的弹性。

客户端也可以设计成智能的，能够根据当前网络条件和服务器响应时间选择最优的服务点。例如，移动应用程序可以在后台检测到最佳的服务端点，并在需要时无缝切换。

### 总结

确保在多区域架构中实施高效的数据居留和路由策略是一个多维度的挑战，涉及到深入理解客户需求、构建稳固的技术基础，并在此基础上实现灵活、可靠的操作环境。从真理和信任的原则出发，坚持一致性，在多区域环境中维护高效同步与故障响应，最后通过定制化的客户端路由策略来应对各种网络和地理位置带来的挑战。只有这样，我们才能在全球范围内提供无缝且高效的服务，满足客户的多样化和日益严格的需求。