引言

这天，我九点多下了班回到家看了会书，洗漱好十一点多了，正准备睡觉时，领导一个电话打进来：“小杨，线上服务怎么不可用了，有测试反馈登录时拿不到验证码！”

“好的，那我先看日志排查下”。此时我内心 OS，应该不是服务问题，先不急！

这倒不是对我写的代码质量有信心，主要是最近也没发版，而且晚上那会还是正常的，突然就不可用了，大概率是环境问题，就像上次阿里云一样。

而我们的服务都部署在腾讯云集群，所有的中间件也都是腾讯云的，包括 CLS 日志服务、 SMS 短信服务、MySQL、Redis 等。



短信不可用

此时，领导拉起了一个临时小群，说目前看到的情况是无法接收验证码，每次点击获取验证码时，前端就会报一个 “服务内部错误”。

![image-20231121092845727](imgs/image-20231121092845727.png)

而这，更加证明了我的猜想。

由于后台服务有一套完善的错误码设计体系，所以我们在接口返回中，会报出详细的错误类型和说明。

而 “服务内部错误”，几乎都是和环境、以及组件依赖相关的，比如 MySQL、SMS 等云端应用。

> 不了解如何做错误码设计的，可以看我这篇文章：错误码



权限问题

当然，除了组件本身的问题，还有可能是权限访问问题。

我们团队是今年上半年刚组建，当时服务刚搭建，所以还没有运维人员。每次申请账号权限是就默认给自己一个管理员权限，并且在系统里也是用了自己的账号密钥，去管理 SMS 短信、MySQL 等依赖。

之前就出过一次，运维同学在发版时为了规范权限，把我们开发人员的 SMS 短信服务的管理员权限收了，开了个只读权限，导致服务连不上 SMS 影响了线上使用。

这次，估计又是运维同学搞事情，把我们开发的账号权限回收了吧！



呼他手机

这时，领导拉起了一个小群 “短信发不了”，并且称测试反馈当前开发、测试和正式环境都出了问题，需要赶紧解决，不然可能要故障升级了。

![img](imgs/企业微信截图_17005309642339.png)

并且补充了一句：“今晚有几个客户可能会来使用我们的系统！”

![image-20231121094605466](imgs/image-20231121094605466.png)

这时，领导似乎想起了什么，问我：“之前短信服务是不是也崩过一次，上次不可用是什么原因来着？”

我回应了说是运维回收了权限导致的，并且已经给咱们公司的运维负责人发消息了，但是他还没有回应。

领导想也没想：“我拉个语音会议，呼他手机！”



日志情况

运维负责人进了会议后，第一时间反馈没有修改任何权限，并且最近都没动腾讯云的账号了。

“不是权限问题，那是什么原因呢”，领导又发话了。

这时，我通过日志的错误类型定位到了具体报错信息：

![image-20231121094200167](imgs/image-20231121094200167.png)

从日志来看，是访问腾讯云 SMS 短信服务时返回了错误信息：ClientError.NetworkError，网络异常。

我赶紧把日志截图发到了群里，并同步到了腾讯云技术支持群：

![img](imgs/企业微信截图_17005315902922.png)

同时，又有同事在群里反馈，cos 对象存储服务也用不了。

![img](imgs/企业微信截图_17005338338607.png)

这时，已经快晚上十一点半了，我想起了之前阿里云事故，也是对象存储服务不可用导致淘宝、闲鱼等一系列应用不可用，而这次，腾讯云也要重蹈覆辙了吗？！

> 时光穿梭机：
>
> * 阿里云事故



技术支持

两个腾讯云产品同时出现问题，而且还是 VIP 甲方的问题，技术支持也坐不住了，很快在群里做出了响应：

![img](imgs/企业微信截图_17005317011853.png)

我在群里回复技术顾问：是的，正式环境有客户用，急，在线等解决！

同时，领导已经把腾讯云的负责人拉进了语音群聊，问题再一次得到了升级。

腾讯云负责人本来睡意朦胧，已经快睡着了，但看到群消息后立即清醒了过来，并立即拉了四个腾讯的运维人员到语音群里，开始排查。

首先，从日志出发看到是网络问题，于是技术人员让我们从集群、以及非集群的云服务器上，看下是否可以 ping 通 SMS 短信服务的域名。

我在集群 pod 里试了下，果然，访问不通：

![img](imgs/企业微信截图_17004955013075.png)

同时，运维人员排查了腾讯云的整体网络链路，但是并没有发现问题。

这时，已经晚上十二点过了。



集群域名解析问题？

网络没有问题？那不应该 ping 不通啊，就像我们可以在本地正常访问百度一样，任何一台联网的计算机都可以正常 ping 通互联网上任意一个未隔离的公网域名，就像这样：

![image-20231121102339410](imgs/image-20231121102339410.png)

诶？等等，未隔离，腾讯云 SMS 短信服务面向全球用户，肯定不会对某台计算机进行隔离，那我本地应该也可以访问通啊，试一下：

![image-20231121102613447](imgs/image-20231121102613447.png)

果然可以，那为啥我们线上的集群访问不通呢？

这时，我想到之前有一次也出过类似的问题，当时我们三个（开发、测试和正式）环境的所有系统都部署在了一个集群里，整个集群的节点数近 300 个，但是 `coredns`（在 k8s 中提供域名解析、服务发现能力）只有 2 个副本。

所以出现了 coredns 请求量过大，负载过高的问题，导致我们后台服务请求腾讯云资源时，域名解析都非常慢，造成大批量访问超时。

我们集群是部署在腾讯云上海地区的，为了验证是不是集群带宽的问题，我从集群外找了一台上海地区的服务器，继续访问腾讯云 SMS：

![image-20231121105431025](imgs/image-20231121105431025.png)

还是访问不通！

这时，我们的运维老大说：“广州地区的云服务器可以 ping 通腾讯云 SMS，但是上海地区的机器都不行”。



VPC问题

腾讯云的运维人员听到这个反馈，赶紧做了地区网络排查，发现上海地区的网络环境良好，访问腾讯云应用也是正常的。

那难道是我们自己的 VPC（Virtual Private Cloud，私有网络）有问题吗？

可是腾讯运维人员也没有我们的 VPC 机器啊，于是，运维老大说可以给出一台空闲的 VPC 机器，让腾讯运维人员多次访问抓包看一下。

这时，已经是凌晨十二点半了！

经过运维人员的多次访问和抓包，发现有很小几率可以访问通，但是大部分请求都会超时。

那可能不是网络问题，而是限流问题，和我们上次的 coredns 一样？

果不其然，运维人员查看了下内部限流策略，是我们的 VPC 下的 dns 解析被腾讯云限制访问频率了。



爬虫流量过大被限制

又经过一番排查，腾讯的运维人员发现，在我们公司的 VPC 上有个爬虫服务，在一个小时前开启了压测，正在大批量爬取外部域名，占用了过高的 dns 资源。

于是，腾讯云的 dns 告警将它视为不良用户，将整个 VPC 的 dns 解析限频了，所以当服务调用腾讯云域名时，由于排队时间太久& dns 资源不足，所以报了网络错误的异常。

当腾讯运维人员把限频解除，等了两三分钟后，短信服务、对象存储服务等应用终于恢复正常。

![image-20231121213103185](imgs/image-20231121213103185.png)



小结

后来，腾讯云的负责人召集运维人员做了紧急复盘，确认目前 dns 限频和爬虫封禁的策略未公开，所以导致同一个 VPC 下的服务可能会影响别的线上业务，并短暂表达了歉意。

而经过这件事过后，爬虫和压测类的服务，我们都用上了弹性资源，并且与线上服务做了进一步 VPC 地区隔离，希望能避免类似的情况。

好了，今天的 BUG 分享就到这，感谢各位读者耐心看完我这平淡的陈述，排查问题时的惊心动魄难以言语，但在座的大佬应该理解的！

最后，希望大家可以提出问题和想法，我们一起讨论一下。